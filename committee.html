<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ØªØ³Ø¬ÙŠÙ„ Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù„Ø¬Ù†Ø©</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* Ø£Ù†Ù…Ø§Ø· Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª */
    .tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 1px solid #e6e9ef;
    }
    .tab-btn {
      background: none;
      border: none;
      padding: 12px 20px;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      font-size: 14px;
      color: #6b7280;
      transition: all 0.3s;
    }
    .tab-btn.active {
      color: #0b5cff;
      border-bottom-color: #0b5cff;
      font-weight: bold;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
      animation: fadeIn 0.5s;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* Ø£Ù†Ù…Ø§Ø· Ø®Ø§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ† */
    .candidate-item {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #e6e9ef;
      margin-bottom: 10px;
    }
    .candidate-item label {
      font-weight: bold;
      color: #2c3e50;
      margin-bottom: 8px;
      display: block;
    }
    .candidates-grid {
      display: grid;
      gap: 15px;
      margin-top: 15px;
    }
    @media (min-width: 768px) {
      .candidates-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    @media (min-width: 1024px) {
      .candidates-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    /* Ø£Ù†Ù…Ø§Ø· Ø¥Ø¶Ø§ÙÙŠØ© */
    .form-group {
      margin-bottom: 20px;
    }
    .attendance-result {
      background: #e8f5e8;
      padding: 20px;
      border-radius: 8px;
      border: 2px solid #4caf50;
      margin-top: 20px;
      text-align: center;
    }
    .protocol-preview {
      max-width: 300px;
      max-height: 400px;
      border: 2px solid #ddd;
      border-radius: 8px;
      margin: 15px 0;
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="header">
        <div>
          <div class="h1">ØªØ³Ø¬ÙŠÙ„ Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù„Ø¬Ù†Ø©</div>
          <div id="userInfo" class="small muted">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
        </div>
        <div class="row">
          <button id="logoutBtn" class="btn-ghost">Ø®Ø±ÙˆØ¬</button>
        </div>
      </div>

      <!-- ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„ØµÙØ­Ø© -->
      <div class="tabs">
        <button class="tab-btn" onclick="switchTab('counting')">Ø§Ù„ÙØ±Ø²</button>
        <button class="tab-btn active" onclick="switchTab('attendance')">Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ±</button>
        <button class="tab-btn" onclick="switchTab('protocol')">Ù…Ø­Ø¶Ø± Ø§Ù„ÙØ±Ø²</button>
      </div>

      <!-- Ù‚Ø³Ù… Ø§Ù„ÙØ±Ø² -->
      <div id="counting" class="tab-content">
        <div class="grid">
          <div class="card">
            <div class="form-group">
              <label for="totalVotes">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ØµÙˆØ§Øª</label>
              <input type="number" id="totalVotes" min="0" class="input" placeholder="Ø£Ø¯Ø®Ù„ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙˆØ§Øª"/>
            </div>
            
            <div class="form-group">
              <label for="attendance">Ø§Ù„Ø­Ø¶ÙˆØ±</label>
              <input type="number" id="attendance" min="0" class="input" placeholder="Ø£Ø¯Ø®Ù„ Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¶ÙˆØ±"/>
            </div>
            
            <div class="form-group">
              <label for="valid">Ø§Ù„ØµØ­ÙŠØ­</label>
              <input type="number" id="valid" min="0" class="input" placeholder="Ø£Ø¯Ø®Ù„ Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙˆØ§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©"/>
            </div>
            
            <div class="form-group">
              <label for="invalid">Ø§Ù„Ø¨Ø§Ø·Ù„</label>
              <input type="number" id="invalid" min="0" class="input" placeholder="Ø£Ø¯Ø®Ù„ Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙˆØ§Øª Ø§Ù„Ø¨Ø§Ø·Ù„Ø©"/>
            </div>
            
            <div class="small muted" style="background: #f8f9fa; padding: 10px; border-radius: 6px;">
              <p>ğŸ“Œ <strong>Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„ØªØ­Ù‚Ù‚:</strong></p>
              <p>â€¢ Ø§Ù„ØµØ­ÙŠØ­ + Ø§Ù„Ø¨Ø§Ø·Ù„ = Ø§Ù„Ø­Ø¶ÙˆØ±</p>
              <p>â€¢ Ø§Ù„Ø­Ø¶ÙˆØ± â‰¤ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ØµÙˆØ§Øª</p>
              <p>â€¢ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø£ØµÙˆØ§Øª Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ† = 2 Ã— Ø§Ù„Ø£ØµÙˆØ§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©</p>
            </div>
          </div>

          <div class="card">
            <h3>ğŸ—³ï¸ Ø£ØµÙˆØ§Øª Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ† (13 Ù…Ø±Ø´Ø­)</h3>
            <div id="candidatesGrid" class="candidates-grid">
              <!-- Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø®Ø§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ† Ù‡Ù†Ø§ -->
            </div>
          </div>
        </div>

        <div style="margin-top:20px; text-align: center;">
          <button id="saveBtn" class="btn-primary" style="padding: 12px 30px; font-size: 16px;">ğŸ’¾ Ø­ÙØ¸ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙØ±Ø²</button>
          <div id="formMsg" class="error" style="margin-top: 15px;"></div>
        </div>
      </div>

      <!-- Ù‚Ø³Ù… Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ± -->
      <div id="attendance" class="tab-content active">
        <div class="card">
          <h3>ğŸ“Š ØªØ³Ø¬ÙŠÙ„ Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ±</h3>
          <p class="small muted">Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ù„Ø¬Ù†Ø© - ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙƒÙ„ 45 Ø¯Ù‚ÙŠÙ‚Ø©</p>
          
          <div class="form-group">
            <label for="totalCommittee">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ø§Ø®Ø¨ÙŠÙ† ÙÙŠ Ø§Ù„Ù„Ø¬Ù†Ø©</label>
            <input type="number" id="totalCommittee" min="0" class="input" placeholder="Ù…Ø«Ø§Ù„: 500 Ù†Ø§Ø®Ø¨"/>
          </div>
          
          <div class="form-group">
            <label for="currentPresence">Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„ÙØ¹Ù„ÙŠ Ø§Ù„Ø¢Ù†</label>
            <input type="number" id="currentPresence" min="0" class="input" placeholder="Ù…Ø«Ø§Ù„: 350 Ø­Ø§Ø¶Ø±"/>
          </div>
          
          <div class="form-group">
            <label for="attendancePercentage">Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ù…Ø­Ø³ÙˆØ¨Ø©</label>
            <input type="text" id="attendancePercentage" class="input" readonly 
                   style="background-color: #f0f8ff; font-weight: bold; font-size: 18px; text-align: center; color: #0b5cff;"/>
          </div>

          <div id="attendanceValidation" class="error" style="margin-bottom: 15px;"></div>
          
          <div style="margin-top:25px; text-align: center;">
            <button id="saveAttendanceBtn" class="btn-primary" style="background: #27ae60; padding: 12px 30px; font-size: 16px;">
              ğŸ’¾ Ø­ÙØ¸ Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ±
            </button>
          </div>
          
          <div id="attendanceMsg" style="margin-top:15px; text-align: center;"></div>
          
          <div class="small muted" style="margin-top: 25px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
            <p>â° <strong>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ­Ø¯ÙŠØ«:</strong></p>
            <p>â€¢ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ­Ø¯ÙŠØ« Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ± ÙƒÙ„ 45 Ø¯Ù‚ÙŠÙ‚Ø©</p>
            <p>â€¢ Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: <span id="lastUpdateTime">Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø£ÙŠ ØªØ­Ø¯ÙŠØ« Ø¨Ø¹Ø¯</span></p>
          </div>
        </div>

        <!-- Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ -->
        <div id="attendanceResult" class="attendance-result" style="display: none;">
          <h3>âœ… ØªÙ… Ø­ÙØ¸ Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­</h3>
          <div style="font-size: 32px; font-weight: bold; color: #2c3e50; margin: 15px 0;" id="finalPercentage"></div>
          <p class="small muted" id="calculationDetails"></p>
          <p style="margin-top: 10px; color: #27ae60;">âœ”ï¸ ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ø³Ø¨Ø© Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©</p>
        </div>
      </div>

      <!-- Ù‚Ø³Ù… Ù…Ø­Ø¶Ø± Ø§Ù„ÙØ±Ø² -->
      <div id="protocol" class="tab-content">
        <div class="card">
          <h3>ğŸ–¼ï¸ Ø±ÙØ¹ ØµÙˆØ±Ø© Ù…Ø­Ø¶Ø± Ø§Ù„ÙØ±Ø²</h3>
          <p class="small muted">Ù‚Ù… Ø¨Ø±ÙØ¹ ØµÙˆØ±Ø© Ù…Ø­Ø¶Ø± Ø§Ù„ÙØ±Ø² Ø§Ù„Ø±Ø³Ù…ÙŠ ÙƒØ¥Ø«Ø¨Ø§Øª Ù„Ù„Ù†ØªØ§Ø¦Ø¬</p>
          
          <div class="form-group">
            <label for="protocolImage">Ø§Ø®ØªØ± ØµÙˆØ±Ø© Ø§Ù„Ù…Ø­Ø¶Ø±</label>
            <input type="file" id="protocolImage" accept="image/*" class="input" style="padding: 10px;">
            <p class="small muted">ğŸ“· ÙŠÙ…ÙƒÙ†Ùƒ ØªØµÙˆÙŠØ± Ø§Ù„Ù…Ø­Ø¶Ø± Ø¨ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ù‡Ø§ØªÙ Ø£Ùˆ Ø±ÙØ¹ ØµÙˆØ±Ø© Ù…ÙˆØ¬ÙˆØ¯Ø©</p>
          </div>

          <div style="text-align: center;">
            <img id="previewImg" class="protocol-preview">
          </div>
          
          <div style="margin-top:25px; text-align: center;">
            <button id="uploadProtocolBtn" class="btn-primary" style="background: #8e44ad; padding: 12px 30px; font-size: 16px;">
              ğŸ“¤ Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„Ù…Ø­Ø¶Ø±
            </button>
          </div>
          
          <div id="protocolMsg" style="margin-top:15px; text-align: center;"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Ø¯Ø§Ù„Ø© Ø¨Ø³ÙŠØ·Ø© ÙˆÙ…Ø¶Ù…ÙˆÙ†Ø© Ù„ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
    function switchTab(tabName) {
      console.log('ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ Ø§Ù„ØªØ¨ÙˆÙŠØ¨:', tabName);
      
      // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙŠØ§Øª
      const tabContents = document.querySelectorAll('.tab-content');
      tabContents.forEach(content => {
        content.classList.remove('active');
      });
      
      // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù†Ø´Ø§Ø· Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
      const tabBtns = document.querySelectorAll('.tab-btn');
      tabBtns.forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø­Ø¯Ø¯
      const activeTab = document.getElementById(tabName);
      if (activeTab) {
        activeTab.classList.add('active');
      }
      
      // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯
      const activeBtn = document.querySelector(`[onclick="switchTab('${tabName}')"]`);
      if (activeBtn) {
        activeBtn.classList.add('active');
      }
    }

    // Ø¥Ù†Ø´Ø§Ø¡ Ø®Ø§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ†
    function createCandidateFields() {
      console.log('Ø¨Ø¯Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø®Ø§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ†...');
      const candidatesGrid = document.getElementById('candidatesGrid');
      
      if (!candidatesGrid) {
        console.error('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†ØµØ± candidatesGrid');
        return;
      }

      candidatesGrid.innerHTML = '';
      
      for (let i = 1; i <= 13; i++) {
        const candidateDiv = document.createElement('div');
        candidateDiv.className = 'candidate-item';
        candidateDiv.innerHTML = `
          <label for="candidate${i}">Ù…Ø±Ø´Ø­ ${i}</label>
          <input type="number" id="candidate${i}" min="0" value="0" class="input" placeholder="Ø£Ø¯Ø®Ù„ Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙˆØ§Øª">
        `;
        candidatesGrid.appendChild(candidateDiv);
      }
      
      console.log('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ 13 Ø®Ø§Ù†Ø© Ù„Ù„Ù…Ø±Ø´Ø­ÙŠÙ† Ø¨Ù†Ø¬Ø§Ø­');
    }

    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ© Ù„Ù„Ø­Ø¶ÙˆØ±
    function setupAttendanceCalculation() {
      const totalCommittee = document.getElementById('totalCommittee');
      const currentPresence = document.getElementById('currentPresence');
      const attendancePercentage = document.getElementById('attendancePercentage');
      const attendanceValidation = document.getElementById('attendanceValidation');

      function calculatePercentage() {
        const total = parseInt(totalCommittee.value) || 0;
        const current = parseInt(currentPresence.value) || 0;
        
        // Ù…Ø³Ø­ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø®Ø·Ø£ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
        if (attendanceValidation) {
          attendanceValidation.textContent = '';
        }
        
        if (total === 0) {
          if (attendancePercentage) {
            attendancePercentage.value = '';
          }
          return;
        }
        
        if (current > total) {
          if (attendancePercentage) {
            attendancePercentage.value = '!Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨';
          }
          if (attendanceValidation) {
            attendanceValidation.textContent = 'âŒ Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¶ÙˆØ± Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠØªØ¬Ø§ÙˆØ² Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù„Ø¬Ù†Ø©';
            attendanceValidation.style.color = 'red';
          }
          return;
        }
        
        if (total > 0 && current >= 0) {
          const percentage = (current / total) * 100;
          if (attendancePercentage) {
            attendancePercentage.value = percentage.toFixed(2) + '%';
          }
          if (attendanceValidation) {
            attendanceValidation.textContent = 'âœ… Ø§Ù„Ù†Ø³Ø¨Ø© ØµØ­ÙŠØ­Ø© ÙˆØ¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø­ÙØ¸';
            attendanceValidation.style.color = 'green';
          }
        } else {
          if (attendancePercentage) {
            attendancePercentage.value = '';
          }
        }
      }

      if (totalCommittee && currentPresence) {
        totalCommittee.addEventListener('input', calculatePercentage);
        currentPresence.addEventListener('input', calculatePercentage);
      }
    }

    // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø©
    function setupImagePreview() {
      const protocolImage = document.getElementById('protocolImage');
      const previewImg = document.getElementById('previewImg');

      if (protocolImage && previewImg) {
        protocolImage.addEventListener('change', function(e) {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
              previewImg.src = e.target.result;
              previewImg.style.display = 'block';
            }
            reader.readAsDataURL(file);
          } else {
            previewImg.style.display = 'none';
          }
        });
      }
    }

    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
    document.addEventListener('DOMContentLoaded', function() {
      console.log('ØªÙ… ØªØ­Ù…ÙŠÙ„ ØµÙØ­Ø© Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ Ø¨Ù†Ø¬Ø§Ø­');
      
      // Ø¥Ù†Ø´Ø§Ø¡ Ø®Ø§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ†
      createCandidateFields();
      
      // Ø¥Ø¹Ø¯Ø§Ø¯ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©
      setupAttendanceCalculation();
      
      // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø©
      setupImagePreview();
      
      console.log('ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø© Ø§ÙƒØªÙ…Ù„Øª Ø¨Ù†Ø¬Ø§Ø­');
    });
  </script>

  <script type="module">
    import { auth, db } from './firebase.js';
    import { 
      onAuthStateChanged, 
      signOut 
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
    import { 
      doc, getDoc, setDoc, collection, getDocs, query, where, orderBy, limit, serverTimestamp 
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    // Ø¹Ù†Ø§ØµØ± Ø§Ù„ØµÙØ­Ø©
    const userInfo = document.getElementById('userInfo');
    const totalVotes = document.getElementById('totalVotes');
    const attendance = document.getElementById('attendance');
    const valid = document.getElementById('valid');
    const invalid = document.getElementById('invalid');
    const saveBtn = document.getElementById('saveBtn');
    const formMsg = document.getElementById('formMsg');
    const logoutBtn = document.getElementById('logoutBtn');
    const totalCommittee = document.getElementById('totalCommittee');
    const currentPresence = document.getElementById('currentPresence');
    const attendancePercentage = document.getElementById('attendancePercentage');
    const saveAttendanceBtn = document.getElementById('saveAttendanceBtn');
    const attendanceMsg = document.getElementById('attendanceMsg');
    const lastUpdateTime = document.getElementById('lastUpdateTime');
    const attendanceResult = document.getElementById('attendanceResult');
    const finalPercentage = document.getElementById('finalPercentage');
    const calculationDetails = document.getElementById('calculationDetails');
    const protocolImage = document.getElementById('protocolImage');
    const uploadProtocolBtn = document.getElementById('uploadProtocolBtn');
    const protocolMsg = document.getElementById('protocolMsg');

    let currentUser = null;
    let currentProfile = null;

    // Ù…ØªØ§Ø¨Ø¹Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    onAuthStateChanged(auth, async user => {
      if (!user) {
        window.location.href = 'index.html';
        return;
      }
      
      currentUser = user;
      console.log('ØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', user.email);
      
      try {
        const userDoc = await getDoc(doc(db, 'users', user.uid));
        
        if (!userDoc.exists()) {
          if (userInfo) userInfo.textContent = `Ù…Ø±Ø­Ø¨Ø§ ${user.email}`;
          return;
        }
        
        const userData = userDoc.data();
        currentProfile = userData;
        
        if (userData.status === 'pending') {
          if (userInfo) userInfo.textContent = 'â³ Ø­Ø³Ø§Ø¨Ùƒ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©';
          if (saveBtn) saveBtn.disabled = true;
          if (saveAttendanceBtn) saveAttendanceBtn.disabled = true;
          if (uploadProtocolBtn) uploadProtocolBtn.disabled = true;
          return;
        }
        
        if (userData.role === 'admin') {
          window.location.href = 'dashboard.html';
          return;
        }
        
        if (userInfo) userInfo.textContent = `${userData.email} â€” ${userData.committee}`;
        
        // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ±Ø² Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
        try {
          const reportDoc = await getDoc(doc(db, 'reports', user.uid));
          if (reportDoc.exists()) {
            const reportData = reportDoc.data();
            console.log('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ±Ø²:', reportData);
            
            if (totalVotes) totalVotes.value = reportData.totalVotes || '';
            if (attendance) attendance.value = reportData.attendance || '';
            if (valid) valid.value = reportData.valid || '';
            if (invalid) invalid.value = reportData.invalid || '';
            
            // ØªØ­Ù…ÙŠÙ„ Ø£ØµÙˆØ§Øª Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ†
            if (reportData.candidates && Array.isArray(reportData.candidates)) {
              reportData.candidates.forEach(candidate => {
                const candidateInput = document.getElementById(`candidate${candidate.id}`);
                if (candidateInput) {
                  candidateInput.value = candidate.votes || 0;
                }
              });
            }
          }
        } catch (error) {
          console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ±Ø²:', error);
        }
        
        // ØªØ­Ù…ÙŠÙ„ Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ« Ù„Ù„Ø­Ø¶ÙˆØ±
        loadLastAttendanceUpdate();
        
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', error);
        if (userInfo) userInfo.textContent = 'âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
      }
    });

    // Ø¬Ù„Ø¨ Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ« Ù„Ù„Ø­Ø¶ÙˆØ±
    async function loadLastAttendanceUpdate() {
      try {
        const q = query(
          collection(db, 'attendance_updates'),
          where('uid', '==', currentUser.uid),
          orderBy('timestamp', 'desc'),
          limit(1)
        );
        
        const querySnapshot = await getDocs(q);
        if (!querySnapshot.empty) {
          const lastUpdate = querySnapshot.docs[0].data();
          const timeString = new Date(lastUpdate.timestamp?.toDate?.() || lastUpdate.timestamp).toLocaleString('ar-EG');
          if (lastUpdateTime) lastUpdateTime.textContent = timeString;
          
          if (totalCommittee) totalCommittee.value = lastUpdate.totalCommittee || '';
          if (currentPresence) currentPresence.value = lastUpdate.currentPresence || '';
          
          // ØªØ­Ø¯ÙŠØ« Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ±
          const total = parseInt(totalCommittee.value) || 0;
          const current = parseInt(currentPresence.value) || 0;
          if (total > 0 && current >= 0 && attendancePercentage) {
            const percentage = (current / total) * 100;
            attendancePercentage.value = percentage.toFixed(2) + '%';
          }
        } else {
          if (lastUpdateTime) lastUpdateTime.textContent = 'Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø£ÙŠ ØªØ­Ø¯ÙŠØ« Ø¨Ø¹Ø¯';
        }
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ±:', error);
      }
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙˆÙ‚Øª Ø¨ÙŠÙ† Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª (45 Ø¯Ù‚ÙŠÙ‚Ø©)
    async function canUpdateAttendance() {
      try {
        const q = query(
          collection(db, 'attendance_updates'),
          where('uid', '==', currentUser.uid),
          orderBy('timestamp', 'desc'),
          limit(1)
        );
        
        const querySnapshot = await getDocs(q);
        if (querySnapshot.empty) {
          return true;
        }
        
        const lastUpdate = querySnapshot.docs[0].data();
        const lastUpdateTime = lastUpdate.timestamp?.toDate?.() || new Date(lastUpdate.timestamp);
        const lastUpdateTimestamp = new Date(lastUpdateTime).getTime();
        const currentTime = new Date().getTime();
        const diffMinutes = (currentTime - lastUpdateTimestamp) / (1000 * 60);
        
        console.log(`Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ù†Ù‚Ø¶ÙŠ Ù…Ù†Ø° Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ${diffMinutes.toFixed(1)} Ø¯Ù‚ÙŠÙ‚Ø©`);
        return diffMinutes >= 45;
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆÙ‚Øª Ø§Ù„ØªØ­Ø¯ÙŠØ«:', error);
        return true;
      }
    }

    // Ø­ÙØ¸ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙØ±Ø²
    if (saveBtn) {
      saveBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        if (formMsg) {
          formMsg.textContent = '';
          formMsg.style.color = 'red';
        }
        
        const totalVotesValue = Number(totalVotes.value) || 0;
        const attendanceValue = Number(attendance.value) || 0;
        const validValue = Number(valid.value) || 0;
        const invalidValue = Number(invalid.value) || 0;
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        if (validValue + invalidValue !== attendanceValue) {
          if (formMsg) {
            formMsg.textContent = 'âŒ Ø®Ø·Ø£: Ø§Ù„ØµØ­ÙŠØ­ + Ø§Ù„Ø¨Ø§Ø·Ù„ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ³Ø§ÙˆÙŠ Ø§Ù„Ø­Ø¶ÙˆØ±';
            formMsg.style.color = 'red';
          }
          return;
        }
        
        if (attendanceValue > totalVotesValue) {
          if (formMsg) {
            formMsg.textContent = 'âŒ Ø®Ø·Ø£: Ø§Ù„Ø­Ø¶ÙˆØ± Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† Ø£ÙƒØ¨Ø± Ù…Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ØµÙˆØ§Øª';
            formMsg.style.color = 'red';
          }
          return;
        }
        
        if (totalVotesValue < 0 || attendanceValue < 0 || validValue < 0 || invalidValue < 0) {
          if (formMsg) {
            formMsg.textContent = 'âŒ Ø§Ù„Ù‚ÙŠÙ… Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ØªÙƒÙˆÙ† Ø³Ø§Ù„Ø¨Ø©';
            formMsg.style.color = 'red';
          }
          return;
        }

        // Ø¬Ù…Ø¹ Ø£ØµÙˆØ§Øª Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ†
        const candidates = [];
        let totalCandidateVotes = 0;
        
        for (let i = 1; i <= 13; i++) {
          const input = document.getElementById(`candidate${i}`);
          if (input) {
            const votes = Number(input.value) || 0;
            candidates.push({ id: i, votes });
            totalCandidateVotes += votes;
          }
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚: Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø£ØµÙˆØ§Øª Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ† = 2 Ã— Ø§Ù„Ø£ØµÙˆØ§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©
        if (totalCandidateVotes !== 2 * validValue) {
          if (formMsg) {
            formMsg.textContent = `âŒ Ø®Ø·Ø£: Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø£ØµÙˆØ§Øª Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ† (${totalCandidateVotes}) ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ³Ø§ÙˆÙŠ 2 Ã— Ø§Ù„Ø£ØµÙˆØ§Øª Ø§Ù„ØµØ­ÙŠØ­Ø© (${2 * validValue})`;
            formMsg.style.color = 'red';
          }
          return;
        }

        try {
          const payload = {
            uid: currentUser.uid,
            email: currentProfile.email,
            committee: currentProfile.committee,
            totalVotes: totalVotesValue,
            attendance: attendanceValue,
            valid: validValue,
            invalid: invalidValue,
            candidates: candidates,
            updatedAt: new Date().toISOString()
          };
          
          await setDoc(doc(db, 'reports', currentUser.uid), payload);
          if (formMsg) {
            formMsg.textContent = 'âœ… ØªÙ… Ø­ÙØ¸ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙØ±Ø² Ø¨Ù†Ø¬Ø§Ø­!';
            formMsg.style.color = 'green';
          }
          
          setTimeout(() => {
            if (formMsg) formMsg.textContent = '';
          }, 5000);
          
        } catch (error) {
          if (formMsg) {
            formMsg.textContent = 'âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸: ' + error.message;
            formMsg.style.color = 'red';
          }
        }
      });
    }

    // Ø­ÙØ¸ Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ±
    if (saveAttendanceBtn) {
      saveAttendanceBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        if (attendanceMsg) {
          attendanceMsg.textContent = '';
          attendanceMsg.style.color = 'red';
        }
        
        const total = Number(totalCommittee.value) || 0;
        const current = Number(currentPresence.value) || 0;
        
        if (total <= 0) {
          if (attendanceMsg) {
            attendanceMsg.textContent = 'âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù„Ø¬Ù†Ø©';
            attendanceMsg.style.color = 'orange';
          }
          return;
        }
        
        if (current < 0) {
          if (attendanceMsg) {
            attendanceMsg.textContent = 'âš ï¸ Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¶ÙˆØ± Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† Ø³Ø§Ù„Ø¨Ø§Ù‹';
            attendanceMsg.style.color = 'orange';
          }
          return;
        }
        
        if (current > total) {
          if (attendanceMsg) {
            attendanceMsg.textContent = 'âŒ Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¶ÙˆØ± Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠØªØ¬Ø§ÙˆØ² Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù„Ø¬Ù†Ø©';
            attendanceMsg.style.color = 'red';
          }
          return;
        }
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙˆÙ‚Øª Ø¨ÙŠÙ† Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
        const canUpdate = await canUpdateAttendance();
        if (!canUpdate) {
          if (attendanceMsg) {
            attendanceMsg.textContent = 'â° ÙŠÙ…ÙƒÙ†Ùƒ ØªØ­Ø¯ÙŠØ« Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ± ÙƒÙ„ 45 Ø¯Ù‚ÙŠÙ‚Ø© ÙÙ‚Ø·. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±.';
            attendanceMsg.style.color = 'orange';
          }
          return;
        }
        
        try {
          const percentage = (current / total) * 100;
          const attendanceId = currentUser.uid + '_' + new Date().getTime();
          
          const payload = {
            uid: currentUser.uid,
            email: currentProfile.email,
            committee: currentProfile.committee,
            totalCommittee: total,
            currentPresence: current,
            percentage: percentage,
            timestamp: serverTimestamp()
          };
          
          await setDoc(doc(db, 'attendance_updates', attendanceId), payload);
          
          // Ø¹Ø±Ø¶ Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø­Ø³Ø§Ø¨
          if (attendanceResult) {
            attendanceResult.style.display = 'block';
            finalPercentage.textContent = percentage.toFixed(2) + '%';
            calculationDetails.textContent = `(${current} Ã· ${total}) Ã— 100 = ${percentage.toFixed(2)}%`;
          }
          
          if (attendanceMsg) {
            attendanceMsg.textContent = 'âœ… ØªÙ… Ø­ÙØ¸ Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­ ÙˆØªÙ… Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§ Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©';
            attendanceMsg.style.color = 'green';
          }
          
          if (lastUpdateTime) {
            lastUpdateTime.textContent = new Date().toLocaleString('ar-EG');
          }
          
          setTimeout(() => {
            if (attendanceMsg) attendanceMsg.textContent = '';
          }, 5000);
          
        } catch (error) {
          if (attendanceMsg) {
            attendanceMsg.textContent = 'âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸: ' + error.message;
            attendanceMsg.style.color = 'red';
          }
        }
      });
    }

    // Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„Ù…Ø­Ø¶Ø±
    if (uploadProtocolBtn) {
      uploadProtocolBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        if (protocolMsg) {
          protocolMsg.textContent = '';
          protocolMsg.style.color = 'red';
        }
        
        const file = protocolImage.files[0];
        
        if (!file) {
          if (protocolMsg) {
            protocolMsg.textContent = 'âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© Ø§Ù„Ù…Ø­Ø¶Ø± Ø£ÙˆÙ„Ø§Ù‹';
            protocolMsg.style.color = 'orange';
          }
          return;
        }
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© (5MB ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰)
        if (file.size > 5 * 1024 * 1024) {
          if (protocolMsg) {
            protocolMsg.textContent = 'âŒ Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 5MB';
            protocolMsg.style.color = 'red';
          }
          return;
        }
        
        try {
          const protocolId = currentUser.uid + '_protocol_' + new Date().getTime();
          
          const payload = {
            uid: currentUser.uid,
            email: currentProfile.email,
            committee: currentProfile.committee,
            fileName: file.name,
            fileSize: file.size,
            uploadedAt: serverTimestamp(),
            status: 'uploaded'
          };
          
          await setDoc(doc(db, 'protocols', protocolId), payload);
          
          if (protocolMsg) {
            protocolMsg.textContent = 'âœ… ØªÙ… Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„Ù…Ø­Ø¶Ø± Ø¨Ù†Ø¬Ø§Ø­';
            protocolMsg.style.color = 'green';
          }
          
          setTimeout(() => {
            if (protocolMsg) protocolMsg.textContent = '';
          }, 5000);
          
        } catch (error) {
          if (protocolMsg) {
            protocolMsg.textContent = 'âŒ Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©: ' + error.message;
            protocolMsg.style.color = 'red';
          }
        }
      });
    }

    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
    if (logoutBtn) {
      logoutBtn.addEventListener('click', () => {
        signOut(auth).then(() => {
          window.location.href = 'index.html';
        });
      });
    }
  </script>
</body>
</html>